# FIF-A 代码库结构与清理路线图

**文档元数据**
- 版本：v1.0.4
- 最后更新：2025-12-19
- 状态：Active
- 相关文档：`PROJECT_TRACKER.md`, `WORK_BOARD.md`

---

## 概述

本文档记录了当前仓库的目录布局、v1.0.4 的代码卫生计划，以及已采取的具体行动，以保持代码对实验、优化和故障排除的实用性。

---

## 1. 目录结构概览

| 路径 | 用途 | 说明 |
|---|---|---|
| `fif_mvp/` | 主训练栈 | 包含CLI、数据加载器、模型、训练循环、工具函数 |
| `Project_Phase_Reports/` | 发布就绪的产物 | HTML + Markdown 报告（阶段总结、可视化） |
| `docs/` | 实验与设计文档 | `experiment_design.md`、结果报告、**本文档** |
| `scripts/` | 启动脚本与辅助工具 | 分为 `snli_*.sh`、`sst2_*` 及其他工具脚本 |
| `result/` | 运行产物（指标、告警、配置） | 每次运行一个带时间戳的子目录 |
| `fif_simple/` | 遗留原型 | 仅作历史参考保留，无代码路径依赖 |

---

## 2. 重构目标（v1.0.4）

1. **运行时瓶颈**
   - 消除图构建和每步遥测中的 Python 热点
   - 使 Hybrid 训练无需每次运行都进行性能分析即可调试

2. **代码可发现性**
   - 加强模块契约（如数据加载器 vs 训练器 vs 模型）
   - 移除未使用的辅助函数，避免能量流追踪困难

3. **故障排除体验**
   - 在单一位置展示慢路径统计（步时间、guard/watch 事件）
   - 记录如何复现任何实验

4. **遗留代码隔离**
   - 明确标记 `fif_simple` + LaTeX 产物为非 MVP 代码
   - 避免死文件混淆

---

## 3. 已完成的清理工作

| 领域 | 变更 | 影响 |
|---|---|---|
| 图构建 | 使用批量 matmul + masking 重写 `build_knn_edges_batched` | 去除 `B×L` Python 循环，消除最大的墙钟时间热点（T-018/T-019 跟踪） |
| 死代码 | 移除未使用的单样本处理方法（`_run_single`、`_edge_weights`、`_laplacian`、`_smooth`） | 消除误导性 API 表面（自 v1.0.0 起无调用点） |
| 死代码 | 移除未使用的 `build_knn_edges()` 函数 | 简化代码库，仅保留批处理优化版本 |
| 死代码 | 移除未使用的 `per_token_energy()` 函数 | 清理未使用的工具函数 |
| 文档 | 添加本路线图以记录目录布局和卫生计划 | 为入职或提交基础设施问题提供规范参考 |

---

## 4. 待办事项与后续步骤

1. **图缓存**
   - 为 window/knn 边提供可选的磁盘缓存
   - 减少 `recompute_mu=True` 时的重建开销

2. **能量信号集成**
   - 将告警统计（std/p90 趋势）接入 TensorBoard 或 CSV
   - 在训练前提前发现失败

3. **遗留代码归档**
   - 一旦所有引用被文档捕获，将 `fif_simple/` 迁移到 `docs/archive/`

4. **自动化卫生检查**
   - 添加 `tox` 作业或 CI 步骤运行 `ruff` + 选择性单元测试
   - 在合并前捕获未使用的导入和死路径

在 `WORK_BOARD.md`（v1.0.4 节）中跟踪这些事项，以保持与版本规划的一致性。
