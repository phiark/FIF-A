# FIF v1.0.1 – SNLI DDP/能量正则实验报告

## 1. 版本概述
- **目的**：验证 v1.0.1 训练管线（单机 DDP launcher + per-sample 能量聚合）在 SNLI 上的表现，并复现 v1.0.0-B 的设定：Hybrid 启用 `λ=1e-4`、摩擦迭代 `K=3`。
- **运行配置**：seed=42、batch size=256、5 epoch、`train_noise_levels=clean,low,med,high`。baseline 没有能量正则 (`λ=0`)，Hybrid 启用 `λ=1e-4`。
- **结果目录**：`result/1.0.1/snli_{baseline,hybrid}_20251113_*_seed42`.

## 2. 核心指标
| 模型 | acc | macro_f1 | loss | ece | energy_mean | energy_log_mean | pearson_r(E, err) | epoch walltime* |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| Baseline | 0.7767 | 0.7749 | 0.5521 | 0.0288 | 431.57 | 5.81 | -0.097 | 0:44:39 |
| Hybrid (λ=1e-4) | 0.6967 | 0.6951 | 0.6978 | 0.0166 | 0.070 | 0.068 | +0.057 | 1:14:50 |
| Δ (H−B) | -0.0800 | -0.0798 | +0.1457 | -0.0122 | ≈0 | ≈0 | +0.154 | +0:30:11 |

\*walltime 取 `timing.json["train_seconds"]`：Baseline 2680s，Hybrid 4490s。

**观察**：
1. Baseline 在 DDP 修订后与 v1.0.0 相近（acc 下降 0.7pt），性能稳定。
2. Hybrid 仍落后 8pt，并且训练更慢（K=3 + 2×摩擦层使 GPU 计算密集）。
3. Hybrid 的能量均值压缩至 0.07（对数均值 0.068），说明 `λ=1e-4 + 新的 per-sample 聚合` 将能量推向接近 0 的极限，但能量-错误相关性变为正值 (+0.057)，与预期相反。

## 3. 学习动态
1. **Baseline**：验证 acc 由 0.62 → 0.78 单调上升；能量均值随 epoch 上升 (167 → 435)，趋势与 v1.0.0 一致。
2. **Hybrid**：训练能量在前 2 epoch 直接被正则压到 <0.1 (`metrics_epoch.csv` 列 `energy_mean`)，对应 loss 下降缓慢；验证 acc 最高 0.696，收敛受限。
3. **能量压缩副作用**：能量几乎为零导致 `log(1+E)` 梯度趋近常数；正则项失去区分度，模型通过“把所有能量降到极低”来最小化损失，而不是让能量与错误对齐。

## 4. Confusion 分析
| 类别 | Baseline 正确 | Hybrid 正确 | Δ |
| --- | --- | --- | --- |
| entailment (0) | 2932 | 2653 | -279 |
| neutral (1) | 2275 | 2134 | -141 |
| contradiction (2) | 2423 | 2057 | -366 |

Hybrid 的错误主要来自极性类（0/2），误判集中到中性类：`neutral` 列的 FP 从 323/498 提升到 464/584。能量极低导致分类头对噪声嵌入/能量提示失效。

## 5. 能量-错误相关
- Baseline：`pearson_r = -0.097`（弱负相关，与 v1.0.0 相似）。
- Hybrid：`pearson_r = +0.057`，出现反向趋势——能量越高反而稍微更容易出错，说明 λ 的压制破坏了能量的区分度；当前实现中能量读数几乎被正则“钳死”。

## 6. 诊断
1. **能量崩塌**：在新版 per-sample 能量聚合逻辑下，Hybrid 所有摩擦层的能量加和后仍被 λ=1e-4 强行压到 0.07。需要限制正则的作用域（例如只在最后一层使用）或对能量做 log/z-score 标定后再正则。
2. **K=3 + λ=1e-4 的交互**：多迭代步让能量更易衰减，配合 log 正则导致能量被指数级拉低。建议：
   - 提高 `eta_decay` 或降低 `K`，让能量保持可辨别范围；
   - 或改用 `reg = log1p(E / E_ref)`，避免绝对值趋 0。
3. **DDP 目标达成**：timing.json 显示两次运行均无 DataParallel 警告；`train_log` 未出现 scalar gather error，说明 v1.0.1 的基础设施目标完成，可以专注于能量标定问题。

## 7. 后续建议
1. **能量范围调制**：在 Hybrid 中保留 friction 输出能量，但对每个 batch 做 `E_norm = log1p(E) - mean(log1p(E))` 再正则，避免绝对量纲崩塌。
2. **λ 扫描**：尝试 `λ ∈ {1e-5, 5e-5}` 或分层 λ（第一摩擦层 0，第二层 1e-4）以观察能量-错误相关性是否恢复为正。
3. **能量监控**：在 `metrics_epoch.csv` 中新增 `energy_std` 或 `p90` 字段，跟踪能量分布，而不是仅依赖均值/对数均值。
4. **收敛速度**：若 K=3 带来过高计算成本，可在训练前 2 epoch 用 K=1 预热，再切换为 K=3，减轻 30 分钟额外耗时。

---

**产出**：本报告用于记录 v1.0.1 SNLI 运行的初步结果与诊断，后续在 `PROJECT_TRACKER.md` 与论文草稿中引用。
